---
import "../styles/global.css";
import "../styles/print.css";
import SearchInput from "../components/SearchInput.astro";
import ProjectList from "../components/ProjectList.astro";
import DevWarning from "../components/DevWarning.astro";
import MobileMenu from "../components/MobileMenu.astro";
import { getEntry } from "astro:content";
import { siteConfig, getPageTitle, getCanonicalURL, getOGImageURL } from "../config/site";

const { title } = Astro.props;
const cv = await getEntry("pages", "cv");

// Check if cv exists before rendering
if (!cv) {
  throw new Error("CV page content not found at src/content/pages/cv.md");
}

const { Content: CVContent } = await cv.render();

const currentYear = new Date().getFullYear();
const footerText = `Â©${currentYear} ${siteConfig.name} | A minimalist, editorial index-style portfolio built with Astro.`;

// Use centralized config for all metadata
const pageTitle = getPageTitle(title);
const pageDescription = siteConfig.description;
const canonicalURL = getCanonicalURL(Astro.url.pathname);
const ogImageURL = getOGImageURL();
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <!-- Primary Meta Tags -->
        <title>{pageTitle}</title>
        <meta name="title" content={pageTitle} />
        <meta name="description" content={pageDescription} />
        <meta name="author" content={siteConfig.author.name} />

        <!-- Favicon -->
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content={canonicalURL} />
        <meta property="og:title" content={pageTitle} />
        <meta property="og:description" content={pageDescription} />
        <meta property="og:image" content={ogImageURL} />
        <meta property="og:site_name" content={siteConfig.name} />

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content={canonicalURL} />
        <meta property="twitter:title" content={pageTitle} />
        <meta property="twitter:description" content={pageDescription} />
        <meta property="twitter:image" content={ogImageURL} />
        {siteConfig.author.twitter && (
            <meta property="twitter:creator" content={siteConfig.author.twitter} />
        )}

        <!-- Canonical URL -->
        <link rel="canonical" href={canonicalURL} />

        <!-- Analytics (if configured) -->
        {siteConfig.features.analytics && (
            <>
                <script is:inline async src={`https://www.googletagmanager.com/gtag/js?id=${siteConfig.features.analytics}`}></script>
                <script is:inline define:vars={{ analyticsId: siteConfig.features.analytics }}>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){dataLayer.push(arguments);}
                    gtag('js', new Date());
                    gtag('config', analyticsId);
                </script>
            </>
        )}
    </head>
    <body>
        <DevWarning />

        <!-- Mobile burger menu (only visible on mobile) -->
        <MobileMenu>
            {siteConfig.features.search && <SearchInput />}
            <ProjectList />
        </MobileMenu>

        <main class="grid-container">
            <aside class="col-left scroll-area">
                <header class="site-header">
                    <h1>
                        <a href="/" style="text-decoration: none;">{siteConfig.title}</a>
                    </h1>
                </header>

                <nav class="main-nav" aria-label="Main navigation">
                    <ul>
                        {siteConfig.nav.map((item) => (
                            <li><a href={item.href}>{item.label}</a></li>
                        ))}
                    </ul>
                </nav>

                {siteConfig.features.search && (
                    <div class="index-section">
                        <SearchInput />
                        <ProjectList />
                    </div>
                )}
                {!siteConfig.features.search && (
                    <div class="index-section">
                        <ProjectList />
                    </div>
                )}
            </aside>

            <section class="col-middle">
                <slot />
            </section>

            <aside class="col-right">
                <div class="cv-content">
                    <CVContent />
                </div>
            </aside>

            <footer class="site-footer">
                <p>{footerText}</p>
            </footer>
        </main>

        <script is:inline>
            // 1. SEARCH LOGIC - Works for both desktop sidebar and mobile menu
            function initializeSearch() {
                // Get ALL search inputs and project lists (desktop + mobile)
                const searchInputs = document.querySelectorAll('#search');
                const projectLists = document.querySelectorAll('#project-list');

                if (searchInputs.length === 0 || projectLists.length === 0) return;

                // Function to filter projects
                function filterProjects(searchTerm) {
                    const term = searchTerm.toLowerCase();

                    // Filter ALL project lists (desktop + mobile)
                    projectLists.forEach((projectList) => {
                        const items = Array.from(projectList.getElementsByTagName('li'));
                        let visibleCount = 0;

                        items.forEach((item) => {
                            const title = item.getAttribute('data-title') || '';
                            const tags = item.getAttribute('data-tags') || '';
                            const year = item.getAttribute('data-year') || '';

                            if (
                                title.includes(term) ||
                                tags.includes(term) ||
                                year.includes(term)
                            ) {
                                item.style.display = 'block';
                                visibleCount++;
                            } else {
                                item.style.display = 'none';
                            }
                        });

                        // Handle "no results" message for this list
                        const noResults = projectList.nextElementSibling;
                        if (noResults && noResults.id === 'no-results') {
                            noResults.style.display = visibleCount === 0 ? 'block' : 'none';
                        }
                    });
                }

                // Add event listeners to ALL search inputs
                searchInputs.forEach((searchInput) => {
                    searchInput.addEventListener('input', (e) => {
                        const term = e.target.value;
                        filterProjects(term);

                        // Sync search terms across all inputs
                        searchInputs.forEach((otherInput) => {
                            if (otherInput !== searchInput) {
                                otherInput.value = term;
                            }
                        });
                    });
                });
            }

            // Initialize search when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeSearch);
            } else {
                initializeSearch();
            }

            // 2. GALLERY LOGIC
            document.querySelectorAll(".gallery-wrapper").forEach((wrapper) => {
                const gallery = wrapper.querySelector(".gallery");
                const prevBtn = wrapper.querySelector(".prev");
                const nextBtn = wrapper.querySelector(".next");
                if (!gallery || !prevBtn || !nextBtn) return;
                const scrollAmount = () => gallery.clientWidth;
                prevBtn.addEventListener("click", () => {
                    gallery.scrollBy({
                        left: -scrollAmount(),
                        behavior: "smooth",
                    });
                });
                nextBtn.addEventListener("click", () => {
                    gallery.scrollBy({
                        left: scrollAmount(),
                        behavior: "smooth",
                    });
                });
            });
        </script>

        <style>
            /* --- DESKTOP (Standard Sticky Layout) --- */
            @media (min-width: 1024px) {
                .grid-container {
                    display: grid;
                    min-height: 100vh;
                    max-width: 1600px;
                    margin: 0 auto;
                    padding: 4rem;
                    padding-bottom: 0;
                    gap: 4rem;
                    grid-template-columns: 1fr 2fr 1fr;
                    grid-template-rows: 1fr auto;
                    align-items: start;
                }

                .col-middle {
                  width: 100%;
                  max-width: 100%;
                  min-width: 0;
                  overflow-x: hidden;
                }

                .col-left,
                .col-right {
                    position: sticky;
                    top: 4rem;
                    height: fit-content;
                    max-height: calc(100vh - 8rem);
                    overflow-y: auto;
                    scrollbar-width: none;
                }

                .col-left::-webkit-scrollbar,
                .col-right::-webkit-scrollbar {
                    display: none;
                }

                .site-footer {
                    grid-column: 1 / -1;
                    margin-top: 4rem;
                    padding: 1rem 0;
                    border-top: 1px solid var(--border-color);
                    position: relative;
                    z-index: 10;
                    background-color: var(--bg-color);
                }
            }

            /* --- MOBILE (Stacked, NO PROJECT LIST) --- */
            @media (max-width: 1023px) {
              .grid-container {
                display: flex;
                flex-direction: column;
                padding: 1.5rem;
                padding-top: 5rem; /* Space for fixed burger menu */
                gap: 3rem;
                min-height: 100vh;
              }

              .col-left { display: contents; }
              .site-header { order: 1; margin-bottom: 2rem; display: block; }
              .main-nav { order: 2; margin-bottom: 2rem; display: block; }
              .col-middle { order: 3; flex: 1; }

              /* HIDE project list on mobile - it's in burger menu now */
              .index-section {
                display: none !important;
              }

              .col-right {
                order: 4;
                margin-top: 2rem;
                padding-top: 2rem;
                border-top: 1px solid var(--border-color);
              }

              .site-footer {
                order: 5;
                margin-top: 4rem;
                padding-top: 2rem;
                border-top: 1px solid var(--border-color);
              }
            }

            /* --- GLOBAL TYPOGRAPHY --- */
            .main-nav ul {
                display: flex;
                gap: 1.5rem;
                margin-bottom: 3rem;
            }

            .main-nav a {
                text-decoration: none;
            }
            .main-nav a:hover {
                font-weight: 700;
            }

            .cv-content :global(h2) {
                font-size: 0.875rem;
                margin-top: 2rem;
                margin-bottom: 0.5rem;
                color: var(--text-secondary);
            }

            .cv-content :global(p) {
                font-size: 0.875rem;
                margin-bottom: 1rem;
            }

            .site-footer p {
                margin: 0;
            }

            .site-footer {
                font-size: 0.75rem;
                color: var(--text-secondary);
                font-family: var(--font-main);
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }
        </style>
    </body>
</html>
