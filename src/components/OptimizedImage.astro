---
import { Image } from 'astro:assets';

export interface Props {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  loading?: 'lazy' | 'eager';
  class?: string;
  caption?: string;
  quality?: number;
  format?: 'webp' | 'avif' | 'png' | 'jpg';
  sizes?: string;
  widths?: number[];
}

const {
  src,
  alt,
  width = 800,
  height,
  loading = 'lazy',
  class: className = '',
  caption,
  quality = 80,
  format = 'webp',
  sizes = '(max-width: 768px) 100vw, (max-width: 1024px) 75vw, 50vw',
  widths = [400, 600, 800, 1200],
  ...rest
} = Astro.props;

// Import the image if it's a local path
let imageImport;
try {
  if (src.startsWith('/') || src.startsWith('./') || src.startsWith('../')) {
    // For local images, we need to import them
    imageImport = await import(/* @vite-ignore */ src);
  }
} catch (error) {
  console.warn(`Could not import image: ${src}`, error);
}

const imageProps = {
  alt,
  loading,
  quality,
  format,
  sizes,
  widths,
  class: `optimized-image ${className}`,
  ...rest,
};

// Use imported image if available, otherwise use src directly
const imageSrc = imageImport?.default || src;

// Calculate height if aspect ratio is maintained
const aspectHeight = height || (width * 0.75); // Default 4:3 aspect ratio
---

<figure class={`image-figure ${className}`}>
  {imageImport ? (
    <Image
      src={imageSrc}
      alt={alt}
      width={width}
      height={aspectHeight}
      {...imageProps}
    />
  ) : (
    <!-- Fallback for external images -->
    <img
      src={src}
      alt={alt}
      width={width}
      height={aspectHeight}
      loading={loading}
      class={`optimized-image ${className}`}
      {...rest}
    />
  )}

  {caption && (
    <figcaption class="image-caption">
      {caption}
    </figcaption>
  )}
</figure>

<style>
  .image-figure {
    margin: 2rem 0;
    border: 1px solid var(--border-color);
    overflow: hidden;
  }

  .optimized-image {
    width: 100%;
    height: auto;
    display: block;
    margin: 0;
    border: none;

    /* Smooth loading transition */
    transition: opacity 0.3s ease;
  }

  .optimized-image[loading="lazy"] {
    opacity: 0;
    animation: fadeIn 0.3s ease forwards;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .image-caption {
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
    background-color: var(--bg-color);
    border-top: 1px solid var(--border-color);
    font-style: italic;
    line-height: 1.4;
  }

  /* Hover effects for editorial feel */
  .image-figure:hover .optimized-image {
    filter: grayscale(0%);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .image-figure {
      margin: 1.5rem 0;
    }

    .image-caption {
      padding: 0.5rem 0.75rem;
      font-size: 0.8rem;
    }
  }

  /* Gallery-specific styles when used in galleries */
  .gallery .image-figure {
    margin: 0;
    border: none;
    flex: 0 0 100%;
    height: 100%;
  }

  .gallery .optimized-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .gallery .image-caption {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    margin: 0;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .gallery .image-figure:hover .image-caption {
    opacity: 1;
  }
</style>
